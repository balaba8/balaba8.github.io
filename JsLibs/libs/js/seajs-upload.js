/*! 作者:阿伟 */
/*! git:https://github.com/aweiu/JsLibs.git */
/*! 推荐sealoader模块加载器:https://www.npmjs.com/package/sealoader */
/*! 最后修改于 2016-04-18 11:35:42 */
define(function(require,exports,module){var assetsUrl=module.uri;assetsUrl=assetsUrl.substring(0,assetsUrl.lastIndexOf("/js/"))+"/";var config={},ifr_code=0;exports["int"]=function(a){config=a;var b=config.uploadIpts;if(b){document.removeEventListener("change",changeFuc);var c=Object.prototype.toString.call(b).slice(8,-1);"Array"!=c&&"HTMLCollection"!=c&&(b=[b]);for(var d=0,e=b.length;e>d;d++)b[d].addEventListener("change",changeFuc)}};var getIfrCode=function(){for(;document.getElementsByName("ifr_"+ifr_code).length>0;)ifr_code++;return"ifr_"+ifr_code},clearFile=function(a){try{a.file=null,a.value="",a.select(),document.selection.clear()}catch(b){}finally{return!1}},getOffset=function(a,b){var c=a.getBoundingClientRect(),d=b.getBoundingClientRect();return{left:c.left-d.left,top:c.top-d.top}},createWrapper=function(a){var b=a.mySuperWrapper;return b||(b=document.createElement("mySuperWrapper"),a.mySuperWrapper=b,b.style.cssText="position:relative;float:left;"),a.insertBefore(b,a.firstChild),b},getDw=function(a){var b=a.parentNode.mySuperWrapper,c=getOffset(a,a.parentNode),d={l:c.left,t:c.top};return"fixed"==getComputedStyle(a).position?d:(c=getOffset(b,b.parentNode),{l:d.l-c.left,t:d.t-c.top})},showWaiting=function(a){var b,c=function(){var c=getDw(a),d=a.getBoundingClientRect();b.style.left=c.l+"px",b.style.top=c.t+"px",b.style.width=d.right-d.left+"px",b.style.height=d.bottom-d.top+"px"};a.showWaiting=function(){if(b=this.waiting_bg)b.style.display="table";else{b=document.createElement("table"),a.waiting_bg=b,b.style.cssText="position:absolute;background-color: rgba(0, 0, 0, .5);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=#7f000000,endColorstr=#7f000000);z-index:99999999999;";var d=document.createElement("td");d.style.cssText="color:white;text-align:center;vertical-align: middle;",d.innerHTML="<img src='"+assetsUrl+"imgs/seajs-uploadImgs-loading.gif'/>",b.appendChild(d);var e=createWrapper(this.parentNode);e.appendChild(b),a.addEventListener("load",c),a.hideWaiting=function(){this.waiting_bg&&(this.waiting_bg.style.display="none",this.removeEventListener("load",c))}}c()}},checkImg=function(a){var b=function(b){if(a.accept){var c=a.accept.split(",");if(-1==c.indexOf(b))return alert("仅支持"+a.accept+"格式文件"),!1}return!0};try{var c=a.files[0];if(!b(c.type))return!1;var d=config.maxFileSize;return c.size>d?(1024>d?alert("文件大小不能超过"+d+"字节"):1048576>d?(d/=1024,alert("文件大小不能超过"+d.toFixed(2)+"KB")):(d/=1048576,alert("文件大小不能超过"+d.toFixed(2)+"MB")),!1):!0}catch(e){var f=a.value,g="image/"+f.substring(f.lastIndexOf(".")+1).toLowerCase();return!!b(g)}},preImg=function(a,b){showWaiting(a);try{var c=new FileReader;c.readAsDataURL(b),c.onload=function(){a.src=this.result,a.showWaiting()}}catch(d){a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b+"',sizingMethod='scale')",a.showWaiting()}},changeFuc=function(e){var target=e.srcElement||e.target;if("file"==target.type){var uploadUrl=target.getAttribute("uploadUrl")||config.uploadUrl;if(null==uploadUrl)return void console.log("尚未设置提交地址");try{target.select(),target.blur();var filePath=document.selection.createRange().text}catch(e){filePath=target.files[0]}finally{if(!filePath)return;if(!checkImg(target))return clearFile(target);var imgTo=target.getAttribute("imgTo");if(imgTo){var img=document.getElementById(imgTo);img&&preImg(img,filePath)}var dataForm=target.dataForm,ifr;if(dataForm)ifr=dataForm.ifr;else{var ifr_name=getIfrCode();dataForm=document.createElement("form"),dataForm.method="post",dataForm.action=config.uploadUrl,dataForm.enctype="multipart/form-data",dataForm.encoding="multipart/form-data",dataForm.encType="multipart/form-data",dataForm.target=ifr_name,dataForm.style.display="none",ifr=document.createElement("iframe"),ifr.name=ifr_name,ifr.style.display="none",ifr.addEventListener("load",function(){if(this.hasSubmit){this.hasSubmit=!1;var rs=window.frames[this.name].document.body.innerHTML;rs=rs.replace(/<.+?>/gim,"");try{rs=eval("("+rs+")")}catch(e){console.log(e)}finally{config.onUploadFinish&&config.onUploadFinish(rs,target.getAttribute("actionName"));var jsonTo=target.getAttribute("jsonTo");if(jsonTo){var jsonTo_ipt=document.getElementById(jsonTo);if(jsonTo_ipt){var jsonValue=jsonTo_ipt.getAttribute("jsonValue");null!=jsonValue&&(jsonTo_ipt.value=eval("rs"+jsonValue))}}img&&img.hideWaiting()}}}),document.body.appendChild(dataForm),dataForm.appendChild(ifr),dataForm.ifr=ifr,target.dataForm=dataForm}var tmp=target.nextSibling;dataForm.appendChild(target),ifr.hasSubmit=!0,dataForm.submit(),tmp.parentNode.insertBefore(target,tmp)}}};document.addEventListener("change",changeFuc),exports.newInstance=function(){return exports}});